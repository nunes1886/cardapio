<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card치pio Digital</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-danger sticky-top shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">游꼢 Sabor & Cia</a>
            
            <button class="btn btn-warning position-relative" onclick="abrirCarrinho()">
                <i class="bi bi-cart-fill"></i> Carrinho
                <span id="contador-carrinho" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark">
                    0
                </span>
            </button>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        <h4 class="mb-3 text-secondary border-bottom pb-2">Destaques do Chef</h4>

        <div class="row" id="lista-produtos">
            
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 text-muted fw-bold">Puxando os pratos do chef...</p>
            </div>

        </div>
    </div>

    <div class="offcanvas offcanvas-end shadow" tabindex="-1" id="carrinhoLateral" aria-labelledby="carrinhoLateralLabel">
        
        <div class="offcanvas-header bg-light border-bottom">
            <h5 class="offcanvas-title fw-bold" id="carrinhoLateralLabel">
                <i class="bi bi-cart-check-fill text-danger"></i> Seu Pedido
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        
        <div class="offcanvas-body d-flex flex-column">
            
            <div id="itens-do-carrinho" class="flex-grow-1 overflow-auto mb-3">
                    <p class="text-muted text-center mt-4">Seu carrinho est치 vazio.</p>
                </div>

                <div class="border-top pt-3 mb-3">
                    
                    <label class="form-label text-muted small mb-1 fw-bold">Como deseja receber?</label>
                    <select id="tipo-pedido" class="form-select form-select-sm mb-3 bg-light border-secondary" onchange="alternarTipoPedido()">
                        <option value="mesa">Comer no Local (Mesa)</option>
                        <option value="delivery">Entrega (Delivery)</option>
                    </select>

                    <label for="nome-cliente" class="form-label text-muted small mb-1 fw-bold">Seu Nome:</label>
                    <input type="text" id="nome-cliente" class="form-control form-control-sm mb-3 bg-light" placeholder="Ex: Gledson">

                    <div id="bloco-mesa">
                        <label for="numero-mesa" class="form-label text-muted small mb-1 fw-bold">N칰mero da Mesa:</label>
                        <input type="text" id="numero-mesa" class="form-control form-control-sm bg-light" placeholder="Ex: 12">
                    </div>

                    <div id="bloco-delivery" class="d-none">
                        <label for="telefone-cliente" class="form-label text-muted small mb-1 fw-bold">WhatsApp:</label>
                        <input type="text" id="telefone-cliente" class="form-control form-control-sm mb-2 bg-light" placeholder="Ex: (79) 99999-0000" maxlength="15" oninput="mascaraTelefone(event)">

                        <label for="endereco-cliente" class="form-label text-muted small mb-1 fw-bold">Endere칞o Completo:</label>
                        <input type="text" id="endereco-cliente" class="form-control form-control-sm mb-2 bg-light" placeholder="Rua, N칰mero, Bairro, Refer칡ncia">
                        
                        <label for="troco-para" class="form-label text-muted small mb-1 fw-bold">Troco para (se for em dinheiro):</label>
                        <input type="text" id="troco-para" class="form-control form-control-sm bg-light" placeholder="Ex: 100 reais (ou deixe em branco)">
                    </div>

                </div>
                
            <div class="border-top pt-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="fs-5 text-muted">Total:</span>
                    <span class="fs-4 fw-bold text-success" id="total-carrinho">R$ 0,00</span>
                </div>
                
                <p class="text-center text-muted small mb-2">Como deseja pagar?</p>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary fw-bold" onclick="pagarNaMesaPix()">
                        <i class="bi bi-qr-code-scan"></i> Pagar na Mesa (Pix)
                    </button>
                    <button class="btn btn-outline-secondary fw-bold" onclick="enviarPedido('CAIXA')">
                        <i class="bi bi-cash-coin"></i> Pagar no Caixa
                    </button>
                </div>
            </div>
            
        </div>
    </div>
    <div class="modal fade" id="modalPix" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-x-diamond-fill"></i> Pagamento via Pix
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body text-center py-4">
                    <p class="mb-1 text-muted">Valor total a pagar:</p>
                    <h2 class="fw-bold text-success mb-4" id="valor-pix-tela">R$ 0,00</h2>
                    
                    <div class="bg-light p-3 d-inline-block rounded-3 mb-4 border">
                        <img id="imagem-qrcode" src="" alt="QR Code Pix" style="width: 180px; height: 180px;">
                    </div>
                    
                    <p class="text-muted small mb-2">Ou use o Pix Copia e Cola:</p>
                    <div class="input-group mb-3 px-3">
                        <input type="text" class="form-control text-muted" id="codigo-pix-copia" value="00020126580014br.gov.bcb.pix.exemplo..." readonly>
                        <button class="btn btn-outline-success fw-bold" onclick="copiarPix()">Copiar</button>
                    </div>
                </div>

                <div class="modal-footer border-0 justify-content-center pb-4">
                     <button class="btn btn-success btn-lg w-75 fw-bold rounded-pill shadow-sm" onclick="enviarPedido('PIX')">
                        J치 fiz o pagamento
                     </button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
       let carrinho = [];

        // 1. Adiciona o item e mostra um feedback visual
        function adicionarItem(nome, preco) {
            carrinho.push({ nome: nome, preco: preco });
            atualizarContador();
            renderizarCarrinho(); // Atualiza a lista visualmente
            
            // Opcional: Abre o carrinho automaticamente ao adicionar
            abrirCarrinho(); 
        }

        // 2. Atualiza a bolinha vermelha no topo
        function atualizarContador() {
            document.getElementById('contador-carrinho').innerText = carrinho.length;
        }

        // Alterna os campos entre Mesa e Delivery
        window.alternarTipoPedido = function() {
            let tipo = document.getElementById('tipo-pedido').value;
            let blocoMesa = document.getElementById('bloco-mesa');
            let blocoDelivery = document.getElementById('bloco-delivery');
            
            if (tipo === 'delivery') {
                blocoMesa.classList.add('d-none');
                blocoDelivery.classList.remove('d-none');
            } else {
                blocoMesa.classList.remove('d-none');
                blocoDelivery.classList.add('d-none');
            }
        }

        // M치scara autom치tica para o WhatsApp: (XX) XXXXX-XXXX
        window.mascaraTelefone = function(event) {
            let input = event.target;
            // Remove tudo que n칚o for n칰mero
            let valor = input.value.replace(/\D/g, ""); 
            
            // Limita a 11 n칰meros no m치ximo (DDD + 9 d칤gitos)
            if (valor.length > 11) valor = valor.slice(0, 11); 

            // Aplica a formata칞칚o
            if (valor.length > 2) {
                valor = `(${valor.substring(0, 2)}) ${valor.substring(2)}`;
            }
            if (valor.length > 9) {
                valor = `${valor.substring(0, 10)}-${valor.substring(10)}`;
            }
            
            input.value = valor;
        }

        // 3. Abre a aba lateral do Bootstrap
        function abrirCarrinho() {
            var myOffcanvas = document.getElementById('carrinhoLateral');
            var bsOffcanvas = new bootstrap.Offcanvas(myOffcanvas);
            bsOffcanvas.show();
        }

        // 4. Constr칩i o visual dos itens dentro do carrinho e soma o total
        // 4. Constr칩i o visual dos itens e soma o total
        function renderizarCarrinho() {
            let containerItens = document.getElementById('itens-do-carrinho');
            let totalElemento = document.getElementById('total-carrinho');
            
            if (carrinho.length === 0) {
                containerItens.innerHTML = '<p class="text-muted text-center mt-4">Seu carrinho est치 vazio.</p>';
                totalElemento.innerText = 'R$ 0,00';
                return;
            }

            let htmlItens = '';
            let valorTotal = 0;

            // Cria um cardzinho para cada item no carrinho
            carrinho.forEach((item, index) => {
                valorTotal += item.preco;
                
                htmlItens += `
                    <div class="mb-3 border-bottom pb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <span class="fw-bold d-block">${item.nome}</span>
                                <span class="text-muted small">R$ ${item.preco.toFixed(2).replace('.', ',')}</span>
                            </div>
                            <button class="btn btn-sm btn-light text-danger" onclick="removerItem(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        
                        <input type="text" 
                               class="form-control form-control-sm bg-light" 
                               placeholder="Ex: Sem cebola, bem passado..." 
                               value="${item.observacao || ''}" 
                               onchange="salvarObservacao(${index}, this.value)">
                    </div>
                `;
            });

            containerItens.innerHTML = htmlItens;
            totalElemento.innerText = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
        }

        // 5. Remove um item (se o cliente desistir)
        function removerItem(index) {
            carrinho.splice(index, 1);
            atualizarContador();
            renderizarCarrinho();
        }

        // 5.5 NOVA FUN칂츾O: Salva a observa칞칚o digitada no item correto
        function salvarObservacao(index, texto) {
            carrinho[index].observacao = texto;
            console.log("Carrinho atualizado com observa칞칚o:", carrinho);
        }

        // 6. Bot칫es de Pagamento (Mockups por enquanto)
        // 6. Bot칚o Pagar com Pix (Abre o Modal e gera o QR Code)
        function pagarNaMesaPix() {
            if (carrinho.length === 0) {
                alert("Seu carrinho est치 vazio!");
                return;
            }

            // Soma o valor total
            let valorTotal = carrinho.reduce((total, item) => total + item.preco, 0);

            // Atualiza o valor grande na tela do Modal
            document.getElementById('valor-pix-tela').innerText = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;

            // Gera um QR Code de verdade usando uma API gratuita (para o prot칩tipo)
            let payloadPix = `PIX_SIMULADO_VALOR_${valorTotal}`;
            document.getElementById('imagem-qrcode').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${payloadPix}`;

            // Fecha a aba lateral do carrinho
            var offcanvasElement = document.getElementById('carrinhoLateral');
            var offcanvasInstance = bootstrap.Offcanvas.getInstance(offcanvasElement);
            if(offcanvasInstance) offcanvasInstance.hide();

            // Abre a janelinha (Modal) do Pix
            var modalPix = new bootstrap.Modal(document.getElementById('modalPix'));
            modalPix.show();
        }

        // 7. Fun칞칚o para o bot칚o "Copiar"
        function copiarPix() {
            var inputCopia = document.getElementById("codigo-pix-copia");
            inputCopia.select();
            inputCopia.setSelectionRange(0, 99999); // Para mobile
            navigator.clipboard.writeText(inputCopia.value);
            alert("C칩digo Pix copiado com sucesso!");
        }

        // 8. O cliente clica que j치 pagou
        function confirmarPagamentoPix() {
            alert("Pedido enviado para a cozinha com sucesso! Acompanhe pelo seu celular.");
            
            // Limpa o carrinho para o pr칩ximo pedido
            carrinho = [];
            atualizarContador();
            renderizarCarrinho();
            
            // Fecha o modal do Pix
            var modalElement = document.getElementById('modalPix');
            var modalInstance = bootstrap.Modal.getInstance(modalElement);
            modalInstance.hide();
        }

        function pagarNoCaixa() {
            alert("Pedido enviado! Gerando o n칰mero da comanda para o cliente ir ao caixa...");
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        // Importamos os comandos do Firestore
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChutWVtye9dU_J1WH_9F8DooaDfadJZ3o",
            authDomain: "cardapio-digital-app-4ca1f.firebaseapp.com",
            projectId: "cardapio-digital-app-4ca1f",
            storageBucket: "cardapio-digital-app-4ca1f.firebasestorage.app",
            messagingSenderId: "468777273736",
            appId: "1:468777273736:web:fa7b4b0d8cfdf23f68923d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // Ligando o Banco de Dados

        // Fun칞칚o que busca os dados l치 na nuvem
        async function carregarCardapio() {
            const container = document.getElementById('lista-produtos');
            
            try {
                // Vai na cole칞칚o "cardapio" e traz tudo
                const querySnapshot = await getDocs(collection(db, "cardapio"));
                let html = "";
                
                // Se n칚o tiver nada cadastrado l치
                if (querySnapshot.empty) {
                    container.innerHTML = "<div class='col-12 text-center text-muted py-4'>Nenhum prato cadastrado ainda.</div>";
                    return;
                }

                // Para cada prato que ele achar no banco...
                querySnapshot.forEach((doc) => {
                    const prato = doc.data();
                    
                    // S칩 mostra se estiver dispon칤vel
                    if (prato.disponivel === false) return;

                    // Monta o Card do HTML com os dados do Firebase
                    html += `
                    <div class="col-12 col-md-6 mb-3">
                        <div class="card shadow-sm h-100 border-0">
                            <div class="row g-0 h-100">
                                <div class="col-4">
                                    <img src="${prato.imagem_url || 'https://via.placeholder.com/150'}" class="img-fluid rounded-start h-100" style="object-fit: cover; min-height: 120px;" alt="${prato.nome}">
                                </div>
                                <div class="col-8">
                                    <div class="card-body d-flex flex-column justify-content-between h-100 py-2">
                                        <div>
                                            <h6 class="card-title fw-bold mb-1">${prato.nome}</h6>
                                            <p class="card-text text-muted" style="font-size: 0.85rem;">${prato.descricao}</p>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <span class="fw-bold text-success">R$ ${prato.preco.toFixed(2).replace('.', ',')}</span>
                                            <button class="btn btn-sm btn-outline-danger fw-bold" onclick="adicionarItem('${prato.nome}', ${prato.preco})">
                                                + Add
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                });
                
                // Joga o HTML pronto na tela
                container.innerHTML = html;

            } catch (error) {
                console.error("Erro ao carregar card치pio:", error);
                container.innerHTML = "<div class='col-12 text-center text-danger'>Erro ao conectar com o banco de dados.</div>";
            }
        }

        // Chama a fun칞칚o assim que o site abre
        carregarCardapio();

        // Como estamos dentro de um m칩dulo, precisamos "pendurar" a fun칞칚o no window 
        // para os bot칫es do HTML conseguirem enxerg치-la.
        window.enviarPedido = async function(metodoPagamento) {
            if (carrinho.length === 0) {
                alert("Seu carrinho est치 vazio!");
                return;
            }

            let tipoPedido = document.getElementById('tipo-pedido').value;
            let inputNome = document.getElementById('nome-cliente').value.trim();
            
            // Vari치veis que vamos preencher dependendo da escolha
            let inputMesa = "";
            let dadosDelivery = null;
            let taxaEntrega = 0;

            // Valida칞칫es
            if (inputNome === "") {
                alert("Por favor, preencha o seu Nome!");
                return;
            }

            if (tipoPedido === 'mesa') {
                inputMesa = document.getElementById('numero-mesa').value.trim();
                if (inputMesa === "") {
                    alert("Por favor, preencha o n칰mero da Mesa!");
                    return;
                }
            } else if (tipoPedido === 'delivery') {
                let telefone = document.getElementById('telefone-cliente').value.trim();
                let endereco = document.getElementById('endereco-cliente').value.trim();
                let troco = document.getElementById('troco-para').value.trim();
                
                if (telefone === "" || endereco === "") {
                    alert("Para Delivery, preencha o WhatsApp e o Endere칞o completo!");
                    return;
                }
                
                taxaEntrega = 8.00; // Exemplo de taxa fixa. Poderia vir do Firebase.
                dadosDelivery = {
                    telefone: telefone,
                    endereco: endereco,
                    troco_para: troco
                };
            }

            let valorSubtotal = carrinho.reduce((total, item) => total + item.preco, 0);
            let valorTotalFinal = valorSubtotal + taxaEntrega;

            // Monta o pacote final para o Firebase
            const novoPedido = {
                data_hora: new Date().toLocaleString('pt-BR'),
                cliente_nome: inputNome,
                tipo_pedido: tipoPedido,
                mesa: inputMesa, // Se for delivery, vai vazio
                dados_entrega: dadosDelivery, // Se for mesa, vai como 'null'
                itens: carrinho,
                financeiro: {
                    subtotal: valorSubtotal,
                    taxa_entrega: taxaEntrega,
                    total_final: valorTotalFinal,
                    metodo_pagamento: metodoPagamento
                },
                status: "novo_pedido"
            };

            try {
                const docRef = await addDoc(collection(db, "pedidos"), novoPedido);
                console.log("Pedido salvo com ID: ", docRef.id);
                alert(`Pedido de ${tipoPedido.toUpperCase()} enviado com sucesso!`);
                
                // Limpa a tela
                carrinho = [];
                document.getElementById('nome-cliente').value = "";
                document.getElementById('numero-mesa').value = "";
                document.getElementById('telefone-cliente').value = "";
                document.getElementById('endereco-cliente').value = "";
                document.getElementById('troco-para').value = "";
                
                atualizarContador();
                renderizarCarrinho();

                var offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('carrinhoLateral'));
                if(offcanvas) offcanvas.hide();
                var modalPix = bootstrap.Modal.getInstance(document.getElementById('modalPix'));
                if(modalPix) modalPix.hide();

            } catch (error) {
                console.error("Erro ao enviar pedido: ", error);
                alert("Erro ao enviar o pedido. Tente novamente.");
            }
        }
    </script>
</body>
</html>