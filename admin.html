<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Chef - Gerenciar Card√°pio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; }
    </style>
</head>
<body class="pb-5">

    <div id="tela-login" class="container mt-5" style="max-width: 400px;">
        <div class="card shadow-lg border-0 rounded-4 mt-5">
            <div class="card-header bg-danger text-white text-center py-4 border-0 rounded-top-4">
                <h4 class="mb-0 fw-bold"><i class="bi bi-lock-fill"></i> Acesso Restrito</h4>
                <small>√Årea exclusiva do Chef</small>
            </div>
            <div class="card-body p-4">
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted">E-mail</label>
                    <input type="email" id="email-login" class="form-control form-control-lg bg-light" placeholder="chef@restaurante.com">
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold text-muted">Senha</label>
                    <input type="password" id="senha-login" class="form-control form-control-lg bg-light" placeholder="******">
                </div>
                <button id="btn-entrar" class="btn btn-danger btn-lg w-100 fw-bold shadow-sm">Entrar no Sistema</button>
            </div>
        </div>
    </div>

    <div id="painel-admin" class="container mt-4 d-none" style="max-width: 800px;">
        
        <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm border-start border-5 border-danger">
            <h4 class="mb-0 fw-bold"><i class="bi bi-ui-checks-grid text-danger"></i> Gest√£o do Card√°pio</h4>
            <button id="btn-sair" class="btn btn-outline-secondary fw-bold btn-sm"><i class="bi bi-box-arrow-right"></i> Sair</button>
        </div>

        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-gear-fill"></i> Configura√ß√µes Gerais</h5>
            </div>
            <div class="card-body">
                <label class="form-label fw-bold">Nome do Restaurante</label>
                <div class="input-group">
                    <input type="text" id="nome-restaurante" class="form-control bg-light" placeholder="Ex: Pizzaria Nostra">
                    <button class="btn btn-outline-primary fw-bold" id="btn-salvar-nome">
                        <i class="bi bi-save"></i> Salvar Nome
                    </button>
                </div>
                
                <hr class="my-4">
                
                <label class="form-label fw-bold">Gerenciar Categorias</label>
                <div class="input-group mb-3">
                    <input type="text" id="nova-categoria" class="form-control bg-light" placeholder="Ex: Pizzas, Por√ß√µes, Vegano...">
                    <button class="btn btn-success fw-bold" id="btn-salvar-categoria">
                        <i class="bi bi-plus-circle"></i> Adicionar
                    </button>
                </div>
                
                <ul class="list-group" id="lista-categorias">
                    <li class="list-group-item text-muted text-center">Carregando categorias...</li>
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-5 border-0">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0" id="titulo-form">üë®‚Äçüç≥ Cadastrar Novo Prato</h5>
            </div>
            <div class="card-body">
                <form id="form-prato">
                    <input type="hidden" id="id-prato-edicao" value="">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Nome do Prato/Item</label>
                        <input type="text" id="nome" class="form-control bg-light" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Categoria</label>
                        <select id="categoria" class="form-select bg-light">
                            <option value="">Carregando...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Descri√ß√£o</label>
                        <textarea id="descricao" class="form-control bg-light" rows="2"></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold">Pre√ßo (R$)</label>
                            <input type="number" id="preco" class="form-control bg-light" step="0.01" required>
                        </div>
                        <div class="col-6 d-flex align-items-end">
                            <div class="form-check form-switch fs-5">
                                <input class="form-check-input" type="checkbox" id="disponivel" checked>
                                <label class="form-check-label fs-6 mt-1" for="disponivel">Dispon√≠vel</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">URL da Imagem</label>
                        <input type="url" id="imagem_url" class="form-control bg-light" placeholder="Link da foto">
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success w-100 fw-bold fs-5" id="btn-submit">Salvar Prato</button>
                        <button type="button" class="btn btn-secondary d-none fw-bold" id="btn-cancelar" onclick="cancelarEdicao()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <h4 class="fw-bold mb-3">üìã Pratos Cadastrados</h4>
        <div class="card shadow-sm border-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 bg-white">
                    <thead class="table-dark">
                        <tr>
                            <th>Item</th>
                            <th>Categoria</th>
                            <th>Pre√ßo</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="lista-pratos">
                        <tr><td colspan="5" class="text-center text-muted py-4">Carregando card√°pio...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChutWVtye9dU_J1WH_9F8DooaDfadJZ3o",
            authDomain: "cardapio-digital-app-4ca1f.firebaseapp.com",
            projectId: "cardapio-digital-app-4ca1f",
            storageBucket: "cardapio-digital-app-4ca1f.firebasestorage.app",
            messagingSenderId: "468777273736",
            appId: "1:468777273736:web:fa7b4b0d8cfdf23f68923d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 

        // ==========================================
        // 0. L√ìGICA DE LOGIN 
        // ==========================================
        const telaLogin = document.getElementById('tela-login');
        const painelAdmin = document.getElementById('painel-admin');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                telaLogin.classList.add('d-none');
                painelAdmin.classList.remove('d-none');
            } else {
                telaLogin.classList.remove('d-none');
                painelAdmin.classList.add('d-none');
            }
        });

        document.getElementById('btn-entrar').addEventListener('click', async () => {
            const email = document.getElementById('email-login').value;
            const senha = document.getElementById('senha-login').value;
            const btn = document.getElementById('btn-entrar');
            
            if(!email || !senha) return alert("Preencha e-mail e senha!");
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Entrando...';
            
            try {
                await signInWithEmailAndPassword(auth, email, senha);
            } catch (error) {
                alert("Erro ao fazer login. Verifique e-mail e senha.");
                btn.innerHTML = 'Entrar no Sistema';
            }
        });

        document.getElementById('btn-sair').addEventListener('click', () => {
            signOut(auth);
        });

        // ==========================================
        // 1. CONFIGURA√á√ïES (NOME E CATEGORIAS)
        // ==========================================
        const refConfig = doc(db, "configuracoes", "info_restaurante");
        let categoriasGlobais = []; // Guarda as categorias para podermos editar/excluir

        onSnapshot(refConfig, (snapshot) => {
            if (snapshot.exists()) {
                const dados = snapshot.data();
                if (dados.nome) document.getElementById('nome-restaurante').value = dados.nome;
                
                if (dados.categorias && dados.categorias.length > 0) {
                    categoriasGlobais = dados.categorias;
                    
                    // 1. Atualiza o <select> do formul√°rio de pratos
                    const selectCategoria = document.getElementById('categoria');
                    selectCategoria.innerHTML = ""; 
                    categoriasGlobais.forEach(cat => {
                        selectCategoria.innerHTML += `<option value="${cat}">${cat}</option>`;
                    });

                    // 2. Atualiza a lista visual com os bot√µes Editar/Excluir
                    const listaCat = document.getElementById('lista-categorias');
                    listaCat.innerHTML = "";
                    categoriasGlobais.forEach((cat, index) => {
                        listaCat.innerHTML += `
                            <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                <span class="fw-bold text-secondary">${cat}</span>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editarCategoria(${index}, '${cat}')" title="Editar Nome"><i class="bi bi-pencil-square"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="excluirCategoria('${cat}')" title="Excluir Categoria"><i class="bi bi-trash"></i></button>
                                </div>
                            </li>
                        `;
                    });

                } else {
                    categoriasGlobais = [];
                    document.getElementById('lista-categorias').innerHTML = '<li class="list-group-item text-muted text-center">Nenhuma categoria cadastrada.</li>';
                    document.getElementById('categoria').innerHTML = '<option value="">Sem categorias</option>';
                }
            }
        });

        document.getElementById('btn-salvar-nome').addEventListener('click', async () => {
            const novoNome = document.getElementById('nome-restaurante').value.trim();
            if (novoNome === "") return alert("Digite um nome v√°lido!");
            try {
                await setDoc(refConfig, { nome: novoNome }, { merge: true });
                alert("Nome salvo com sucesso!");
            } catch (error) {
                alert("Erro de seguran√ßa: Voc√™ precisa estar logado para salvar.");
            }
        });

        document.getElementById('btn-salvar-categoria').addEventListener('click', async () => {
            const novaCat = document.getElementById('nova-categoria').value.trim();
            if (novaCat === "") return alert("Digite o nome da categoria!");
            try {
                await updateDoc(refConfig, { categorias: arrayUnion(novaCat) });
                document.getElementById('nova-categoria').value = "";
            } catch (error) {
                alert("Erro de seguran√ßa: Acesso negado.");
            }
        });

        // Fun√ß√µes para Editar e Excluir Categoria
        window.editarCategoria = async function(index, nomeAntigo) {
            // Abre uma janelinha nativa do navegador pedindo o novo nome
            const novoNome = prompt("Editar nome da categoria:", nomeAntigo);
            
            // Se o usu√°rio digitou algo v√°lido e diferente do antigo
            if (novoNome !== null && novoNome.trim() !== "" && novoNome !== nomeAntigo) {
                let novoArray = [...categoriasGlobais]; // Copia a lista atual
                novoArray[index] = novoNome.trim(); // Substitui o nome na posi√ß√£o certa
                
                try {
                    await updateDoc(refConfig, { categorias: novoArray });
                } catch(e) {
                    alert("Erro ao editar categoria. Acesso negado.");
                }
            }
        }

        window.excluirCategoria = async function(nomeParaExcluir) {
            if(confirm(`Tem certeza que deseja excluir a categoria "${nomeParaExcluir}"?\n\nOs pratos que usam ela ficar√£o na aba "Outros" para o cliente.`)) {
                // Cria uma nova lista removendo a categoria escolhida
                let novoArray = categoriasGlobais.filter(cat => cat !== nomeParaExcluir);
                
                try {
                    await updateDoc(refConfig, { categorias: novoArray });
                } catch(e) {
                    alert("Erro ao excluir categoria.");
                }
            }
        }

        // ==========================================
        // 2. LISTAGEM DO CARD√ÅPIO (TEMPO REAL)
        // ==========================================
        const corpoTabela = document.getElementById('lista-pratos');
        
        onSnapshot(collection(db, "cardapio"), (snapshot) => {
            let html = "";
            if (snapshot.empty) {
                corpoTabela.innerHTML = "<tr><td colspan='5' class='text-center text-muted'>Nenhum prato cadastrado ainda.</td></tr>";
                return;
            }

            snapshot.forEach((docSnap) => {
                const prato = docSnap.data();
                const id = docSnap.id;
                const pratoJSON = encodeURIComponent(JSON.stringify(prato));

                html += `
                <tr>
                    <td>
                        <div class="fw-bold">${prato.nome}</div>
                        <small class="text-muted text-truncate d-inline-block" style="max-width: 150px;">${prato.descricao}</small>
                    </td>
                    <td><span class="badge bg-secondary">${prato.categoria}</span></td>
                    <td class="fw-bold text-success">R$ ${prato.preco.toFixed(2).replace('.', ',')}</td>
                    <td class="text-center">
                        ${prato.disponivel 
                            ? '<span class="badge bg-success">Ativo</span>' 
                            : '<span class="badge bg-danger">Inativo</span>'}
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="prepararEdicao('${id}', '${pratoJSON}')" title="Editar">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirPrato('${id}')" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
                `;
            });
            corpoTabela.innerHTML = html;
        });

        // ==========================================
        // 3. SALVAR (CRIAR NOVO OU ATUALIZAR PRATOS)
        // ==========================================
        document.getElementById("form-prato").addEventListener("submit", async function(event) {
            event.preventDefault(); 
            
            const idEdicao = document.getElementById('id-prato-edicao').value;
            const prato = {
                nome: document.getElementById('nome').value,
                categoria: document.getElementById('categoria').value,
                descricao: document.getElementById('descricao').value,
                preco: parseFloat(document.getElementById('preco').value),
                disponivel: document.getElementById('disponivel').checked,
                imagem_url: document.getElementById('imagem_url').value
            };

            try {
                if (idEdicao) {
                    await updateDoc(doc(db, "cardapio", idEdicao), prato);
                    alert("Prato atualizado com sucesso!");
                    window.cancelarEdicao(); 
                } else {
                    await addDoc(collection(db, "cardapio"), prato);
                    alert("Novo prato salvo no card√°pio!");
                    document.getElementById("form-prato").reset();
                }
            } catch (error) {
                console.error("Erro ao salvar: ", error);
                alert("Acesso Negado: Sua sess√£o expirou ou voc√™ n√£o tem permiss√£o.");
            }
        });

        // ==========================================
        // 4. FUN√á√ïES GLOBAIS (PRATOS)
        // ==========================================
        window.excluirPrato = async function(id) {
            if(confirm("Tem certeza que deseja excluir este prato?")) {
                try {
                    await deleteDoc(doc(db, "cardapio", id));
                } catch(e) {
                    alert("Erro: Acesso Negado.");
                }
            }
        }

        window.prepararEdicao = function(id, pratoJSONCodificado) {
            const prato = JSON.parse(decodeURIComponent(pratoJSONCodificado));
            
            document.getElementById('id-prato-edicao').value = id;
            document.getElementById('nome').value = prato.nome;
            document.getElementById('categoria').value = prato.categoria;
            document.getElementById('descricao').value = prato.descricao;
            document.getElementById('preco').value = prato.preco;
            document.getElementById('disponivel').checked = prato.disponivel;
            document.getElementById('imagem_url').value = prato.imagem_url || "";

            document.getElementById('titulo-form').innerHTML = '‚úèÔ∏è Editar Prato';
            document.getElementById('btn-submit').innerText = 'Atualizar Prato';
            document.getElementById('btn-submit').classList.replace('btn-success', 'btn-warning');
            document.getElementById('btn-cancelar').classList.remove('d-none');
            window.scrollTo(0, 0); 
        }

        window.cancelarEdicao = function() {
            document.getElementById("form-prato").reset();
            document.getElementById('id-prato-edicao').value = "";
            document.getElementById('titulo-form').innerHTML = 'üë®‚Äçüç≥ Cadastrar Novo Prato';
            document.getElementById('btn-submit').innerText = 'Salvar Prato';
            document.getElementById('btn-submit').classList.replace('btn-warning', 'btn-success');
            document.getElementById('btn-cancelar').classList.add('d-none');
        }

    </script>
</body>
</html>