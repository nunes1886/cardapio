<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Chef - Gerenciar Card√°pio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body class="bg-light pb-5">

    <div class="container mt-5" style="max-width: 800px;">
        
        <div class="card shadow mb-4 border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-gear-fill"></i> Configura√ß√µes Gerais</h5>
            </div>
            <div class="card-body">
                <label class="form-label fw-bold">Nome do Restaurante</label>
                <div class="input-group">
                    <input type="text" id="nome-restaurante" class="form-control" placeholder="Ex: Pizzaria Nostra">
                    <button class="btn btn-outline-primary fw-bold" id="btn-salvar-nome">
                        <i class="bi bi-save"></i> Salvar Nome
                    </button>
                </div>
                <small class="text-muted">Este nome aparecer√° no topo do aplicativo do cliente.</small>

                <hr class="my-3">
                <label class="form-label fw-bold">Adicionar Nova Categoria</label>
                <div class="input-group">
                    <input type="text" id="nova-categoria" class="form-control" placeholder="Ex: Pizzas, Por√ß√µes, Vegano...">
                    <button class="btn btn-outline-success fw-bold" id="btn-salvar-categoria">
                        <i class="bi bi-plus-circle"></i> Adicionar Categoria
                    </button>
                </div>
                <small class="text-muted">As categorias criadas aparecer√£o nas op√ß√µes do card√°pio.</small>
            </div>
        </div>

        <div class="card shadow mb-5">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0" id="titulo-form">üë®‚Äçüç≥ Cadastrar Novo Prato</h5>
            </div>
            <div class="card-body">
                <form id="form-prato">
                    <input type="hidden" id="id-prato-edicao" value="">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Nome do Prato/Item</label>
                        <input type="text" id="nome" class="form-control" required placeholder="Ex: Lasanha Bolonhesa">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Categoria</label>
                        <select id="categoria" class="form-select">
                            <option value="">Carregando categorias...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Descri√ß√£o (Ingredientes)</label>
                        <textarea id="descricao" class="form-control" rows="2" placeholder="Ex: Massa fresca, molho ao sugo, carne mo√≠da..."></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold">Pre√ßo (R$)</label>
                            <input type="number" id="preco" class="form-control" step="0.01" required placeholder="Ex: 45.90">
                        </div>
                        <div class="col-6 d-flex align-items-end">
                            <div class="form-check form-switch fs-5">
                                <input class="form-check-input" type="checkbox" id="disponivel" checked>
                                <label class="form-check-label fs-6 mt-1" for="disponivel">Dispon√≠vel</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">URL da Imagem (Link)</label>
                        <input type="url" id="imagem_url" class="form-control" placeholder="Cole o link da foto aqui">
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success w-100 fw-bold fs-5" id="btn-submit">Adicionar ao Card√°pio</button>
                        <button type="button" class="btn btn-secondary d-none fw-bold" id="btn-cancelar" onclick="cancelarEdicao()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <h4 class="fw-bold mb-3">üìã Pratos Cadastrados</h4>
        <div class="card shadow">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Item</th>
                            <th>Categoria</th>
                            <th>Pre√ßo</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="lista-pratos">
                        <tr><td colspan="5" class="text-center text-muted">Carregando card√°pio...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        // NOVO: Adicionado arrayUnion na importa√ß√£o
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChutWVtye9dU_J1WH_9F8DooaDfadJZ3o",
            authDomain: "cardapio-digital-app-4ca1f.firebaseapp.com",
            projectId: "cardapio-digital-app-4ca1f",
            storageBucket: "cardapio-digital-app-4ca1f.firebasestorage.app",
            messagingSenderId: "468777273736",
            appId: "1:468777273736:web:fa7b4b0d8cfdf23f68923d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ==========================================
        // 1. CONFIGURA√á√ïES DO RESTAURANTE (NOME E CATEGORIAS)
        // ==========================================
        const refConfig = doc(db, "configuracoes", "info_restaurante");

        // Escuta as configura√ß√µes em tempo real
        onSnapshot(refConfig, (snapshot) => {
            if (snapshot.exists()) {
                const dados = snapshot.data();
                
                if (dados.nome) {
                    document.getElementById('nome-restaurante').value = dados.nome;
                }
                
                // Preenche as op√ß√µes de Categoria no formul√°rio de pratos
                if (dados.categorias && dados.categorias.length > 0) {
                    const selectCategoria = document.getElementById('categoria');
                    selectCategoria.innerHTML = ""; // Limpa as op√ß√µes de "carregando..."
                    
                    dados.categorias.forEach(cat => {
                        selectCategoria.innerHTML += `<option value="${cat}">${cat}</option>`;
                    });
                }
            } else {
                // Se n√£o existir o documento de configura√ß√µes ainda, cria um com valores padr√£o
                setDoc(refConfig, { 
                    nome: "Meu Restaurante", 
                    categorias: ["Sugest√£o do Chef", "Prato Principal", "Lanches", "Sobremesas", "Bebidas"] 
                });
            }
        });

        document.getElementById('btn-salvar-nome').addEventListener('click', async () => {
            const novoNome = document.getElementById('nome-restaurante').value.trim();
            if (novoNome === "") return alert("Digite um nome v√°lido!");
            try {
                await setDoc(refConfig, { nome: novoNome }, { merge: true });
                alert("Nome salvo com sucesso!");
            } catch (error) {
                alert("Erro ao salvar o nome.");
            }
        });

        // L√≥gica para Salvar Nova Categoria
        document.getElementById('btn-salvar-categoria').addEventListener('click', async () => {
            const novaCat = document.getElementById('nova-categoria').value.trim();
            if (novaCat === "") return alert("Digite o nome da categoria!");
            try {
                await updateDoc(refConfig, { categorias: arrayUnion(novaCat) });
                document.getElementById('nova-categoria').value = ""; // Limpa o campo
                alert("Categoria adicionada com sucesso!");
            } catch (error) {
                alert("Erro ao adicionar categoria.");
            }
        });

        // ==========================================
        // 2. LISTAGEM DO CARD√ÅPIO (TEMPO REAL)
        // ==========================================
        const corpoTabela = document.getElementById('lista-pratos');
        
        onSnapshot(collection(db, "cardapio"), (snapshot) => {
            let html = "";
            if (snapshot.empty) {
                corpoTabela.innerHTML = "<tr><td colspan='5' class='text-center text-muted'>Nenhum prato cadastrado ainda.</td></tr>";
                return;
            }

            snapshot.forEach((docSnap) => {
                const prato = docSnap.data();
                const id = docSnap.id;
                const pratoJSON = encodeURIComponent(JSON.stringify(prato));

                html += `
                <tr>
                    <td>
                        <div class="fw-bold">${prato.nome}</div>
                        <small class="text-muted text-truncate d-inline-block" style="max-width: 150px;">${prato.descricao}</small>
                    </td>
                    <td><span class="badge bg-secondary">${prato.categoria}</span></td>
                    <td class="fw-bold text-success">R$ ${prato.preco.toFixed(2).replace('.', ',')}</td>
                    <td class="text-center">
                        ${prato.disponivel 
                            ? '<span class="badge bg-success">Ativo</span>' 
                            : '<span class="badge bg-danger">Inativo</span>'}
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="prepararEdicao('${id}', '${pratoJSON}')" title="Editar">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirPrato('${id}')" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
                `;
            });
            corpoTabela.innerHTML = html;
        });

        // ==========================================
        // 3. SALVAR (CRIAR NOVO OU ATUALIZAR)
        // ==========================================
        document.getElementById("form-prato").addEventListener("submit", async function(event) {
            event.preventDefault(); 
            
            const idEdicao = document.getElementById('id-prato-edicao').value;
            const prato = {
                nome: document.getElementById('nome').value,
                categoria: document.getElementById('categoria').value, // Vai pegar a categoria que o JS preencheu
                descricao: document.getElementById('descricao').value,
                preco: parseFloat(document.getElementById('preco').value),
                disponivel: document.getElementById('disponivel').checked,
                imagem_url: document.getElementById('imagem_url').value
            };

            try {
                if (idEdicao) {
                    await updateDoc(doc(db, "cardapio", idEdicao), prato);
                    alert("Prato atualizado com sucesso!");
                    window.cancelarEdicao(); 
                } else {
                    await addDoc(collection(db, "cardapio"), prato);
                    alert("Novo prato salvo no card√°pio!");
                    document.getElementById("form-prato").reset();
                }
            } catch (error) {
                console.error("Erro ao salvar: ", error);
                alert("Erro ao salvar prato.");
            }
        });

        // ==========================================
        // 4. FUN√á√ïES GLOBAIS DE APOIO (EDITAR E EXCLUIR)
        // ==========================================
        window.excluirPrato = async function(id) {
            if(confirm("Tem certeza que deseja excluir este prato definitivamente?")) {
                await deleteDoc(doc(db, "cardapio", id));
            }
        }

        window.prepararEdicao = function(id, pratoJSONCodificado) {
            const prato = JSON.parse(decodeURIComponent(pratoJSONCodificado));
            
            document.getElementById('id-prato-edicao').value = id;
            document.getElementById('nome').value = prato.nome;
            document.getElementById('categoria').value = prato.categoria;
            document.getElementById('descricao').value = prato.descricao;
            document.getElementById('preco').value = prato.preco;
            document.getElementById('disponivel').checked = prato.disponivel;
            document.getElementById('imagem_url').value = prato.imagem_url || "";

            document.getElementById('titulo-form').innerHTML = '‚úèÔ∏è Editar Prato';
            document.getElementById('btn-submit').innerText = 'Atualizar Prato';
            document.getElementById('btn-submit').classList.replace('btn-success', 'btn-warning');
            document.getElementById('btn-cancelar').classList.remove('d-none');
            
            window.scrollTo(0, 0); 
        }

        window.cancelarEdicao = function() {
            document.getElementById("form-prato").reset();
            document.getElementById('id-prato-edicao').value = "";
            document.getElementById('titulo-form').innerHTML = 'üë®‚Äçüç≥ Cadastrar Novo Prato';
            document.getElementById('btn-submit').innerText = 'Adicionar ao Card√°pio';
            document.getElementById('btn-submit').classList.replace('btn-warning', 'btn-success');
            document.getElementById('btn-cancelar').classList.add('d-none');
        }

    </script>
</body>
</html>